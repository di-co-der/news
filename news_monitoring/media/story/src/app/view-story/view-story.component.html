<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Stories List {{ sourceId ? '- Source #' + sourceId : '' }}</h2>
    <button class="btn btn-primary" (click)="openAddModal()">Add Story</button>
  </div>

  <input
    type="text"
    placeholder="Search by title..."
    [(ngModel)]="searchQuery"
    (input)="onSearchChange()"
    class="form-control mb-3"
  />

  <!-- Show a message when no stories are found -->
  <div *ngIf="stories.length === 0" class="alert alert-info">
    No stories found
  </div>

  <!-- Only show the table when stories exist -->
  <table *ngIf="stories.length > 0" class="table table-bordered">
    <thead>
      <tr>
        <th>Title</th>
        <th>URL</th>
        <th>Published Date</th>
        <th>Source</th>
        <th>Tagged Companies</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let story of stories">
        <td>{{ story.title }}</td>
        <td><a [href]="story.article_url" target="_blank">{{ story.article_url }}</a></td>
        <td>{{ story.published_date | date }}</td>
        <td>
          <ng-container *ngIf="story.source_details; else noSource">
            <a [routerLink]="['/sources', story.source_details.id]">
              {{ story.source_details.name }}
            </a>
          </ng-container>
          <ng-template #noSource>N/A</ng-template>
        </td>
        <td>
          <ng-container *ngIf="story.tagged_companies?.length; else noTags">
            {{ story.tagged_companies?.join(', ') || 'N/A' }}
          </ng-container>
          <ng-template #noTags>N/A</ng-template>
        </td>
        <td>
          <button (click)="openEditModal(story)" class="btn btn-sm btn-primary me-1">Edit</button>
          <button (click)="deleteStory(story.id)" class="btn btn-sm btn-danger">Delete</button>
        </td>
      </tr>
    </tbody>
  </table>

  <!-- Add pagination component here -->
  <nav *ngIf="totalItems > pageSize" class="mt-3">
    <ul class="pagination justify-content-center">
      <li class="page-item" [class.disabled]="currentPage === 1">
        <a class="page-link" (click)="onPageChange(currentPage - 1)">Previous</a>
      </li>

      <li class="page-item" *ngFor="let page of getPages()" [class.active]="page === currentPage">
        <a class="page-link" (click)="onPageChange(page)">{{ page }}</a>
      </li>

      <li class="page-item" [class.disabled]="currentPage === Math.ceil(totalItems / pageSize)">
        <a class="page-link" (click)="onPageChange(currentPage + 1)">Next</a>
      </li>
    </ul>
  </nav>
</div>

<!-- Modal implementation with proper z-index handling -->
<div class="modal-container" *ngIf="showModal">
  <div
    class="modal fade show"
    tabindex="-1"
    [ngStyle]="{ display: showModal ? 'block' : 'none' }"
  >
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            {{ isEditMode ? 'Edit Story' : 'Add Story' }}
          </h5>
          <button type="button" class="btn-close" (click)="closeModal()"></button>
        </div>

        <div class="modal-body">
          <form [formGroup]="storyForm" (ngSubmit)="submitForm()">
            <div class="mb-3">
              <label class="form-label">Title</label>
              <input
                formControlName="title"
                class="form-control"
                [class.is-invalid]="storyForm.get('title')?.invalid && storyForm.get('title')?.touched"
              />
              <div class="invalid-feedback">Title is required</div>
            </div>

            <div class="mb-3">
              <label class="form-label">Article URL</label>
              <input
                formControlName="article_url"
                class="form-control"
                [class.is-invalid]="storyForm.get('article_url')?.invalid && storyForm.get('article_url')?.touched"
              />
              <div class="invalid-feedback">Valid URL is required</div>
            </div>

            <div class="mb-3">
              <label class="form-label">Published Date</label>
              <input
                type="date"
                formControlName="published_date"
                class="form-control"
                [class.is-invalid]="storyForm.get('published_date')?.invalid && storyForm.get('published_date')?.touched"
              />
              <div class="invalid-feedback">Published date is required</div>
            </div>

            <div class="mb-3">
              <label class="form-label">Body Text</label>
              <textarea
                formControlName="body_text"
                class="form-control"
                rows="6"
                [class.is-invalid]="storyForm.get('body_text')?.invalid && storyForm.get('body_text')?.touched"
              ></textarea>
              <div class="invalid-feedback">Body text is required</div>
            </div>

            <div class="mb-3">
              <label class="form-label">Tagged Companies</label>
              <select
                formControlName="tagged_companies"
                class="form-select"
                multiple
              >
                <option *ngFor="let company of companies" [value]="company.id">
                  {{ company.name }}
                </option>
              </select>
              <small class="form-text text-muted">Hold Ctrl/Cmd to select multiple companies</small>
            </div>
          </form>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" (click)="closeModal()">Cancel</button>
          <button
            class="btn btn-primary"
            [disabled]="storyForm.invalid"
            (click)="submitForm()"
          >
            {{ isEditMode ? 'Update' : 'Save' }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Separate backdrop element -->
  <div class="modal-backdrop fade show"></div>
</div>
